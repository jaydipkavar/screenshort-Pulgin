<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Full Page Screenshot with Marks</title>
    </head>

    <body>
        <div style="background-color: red;">
            <h1>Example Web Page</h1>
            <p>This is a paragraph that will be part of the screenshot. Scroll down to see more content.</p>
            <button id="screenshotButton">Click Me to Take Screenshot</button>
            <p>Scroll down to add more content.</p>
            <p>Another paragraph to make the page longer. Keep scrolling...</p>
            <p>Yet another one to make the page even longer. Scroll more...</p>
            <div style="height: auto; background-color: #eee;">
                <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Doloremque eaque ipsum sapiente aliquid
                    explicabo fugit ipsam delectus quasi. Ipsum a totam minima voluptatum fugit facere repudiandae sed
                    excepturi et dolorum!
                    Esse accusantium ducimus cupiditate ratione numquam, animi optio libero eos dolores. Temporibus
                    architecto similique optio porro nobis, veritatis id voluptate quibusdam voluptates sapiente earum
                    impedit molestias, est, dolorem error itaque.
                    Est ipsum esse sequi similique molestias qui veniam suscipit distinctio magnam explicabo doloremque
                    quaerat consequatur beatae saepe quia nam fuga repudiandae ut et ipsam sunt, dicta unde laudantium!
                    Ducimus, voluptatem!
                    Nostrum aperiam, blanditiis corporis dolores, recusandae officiis exercitationem mollitia aliquid
                    vitae incidunt eligendi eum distinctio adipisci ad consectetur fugiat nisi necessitatibus aut dolor
                    harum. Atque, ullam quidem! Veniam, est non!
                    Quis harum culpa vitae excepturi odit id aspernatur sequi architecto nesciunt possimus! Sequi
                    perferendis minima quam error adipisci voluptatem sed, ea ab est harum consequatur cupiditate
                    laborum vel laboriosam officiis!
                    Impedit facere eum rerum labore laudantium expedita dolorum, ad animi. Facilis at assumenda quidem?
                    Accusamus aperiam possimus at commodi adipisci minima cumque dolores quis nulla blanditiis,
                    assumenda non excepturi minus!
                    Aliquid accusamus doloribus quia, quod error sequi sint! Voluptates natus in iure impedit sequi
                    perferendis est temporibus iusto. Ut illo sunt dolorum hic nihil fuga sapiente deserunt aut
                    assumenda debitis.
                    Ab atque, fugit non, et in rerum inventore voluptatibus ut ipsam temporibus enim molestias quam
                    perferendis expedita impedit corrupti maxime. Odio dicta sapiente sed, non corrupti odit aperiam et?
                    Impedit!
                    Dicta doloremque enim laudantium repellat, veniam minus quo a sit tempore impedit nulla. Ullam quam,
                    laboriosam magni non unde quo consectetur voluptatem libero, dolorum sed quia asperiores quaerat
                    nobis provident.
                    Eius unde nulla doloribus deserunt perspiciatis, maiores impedit et aperiam consequatur magnam, sunt
                    quibusdam. Amet nulla maiores, odio ducimus eum asperiores. Enim veniam magni pariatur soluta
                    distinctio. Iure, necessitatibus commodi.
                    Magni harum, laboriosam nostrum esse iusto nesciunt, eveniet saepe ipsam consequatur qui sed rerum,
                    nobis minus et natus at est non temporibus. Corporis quae praesentium suscipit, vero voluptate
                    fugiat voluptatum!
                    Quia, nostrum nemo fugit dignissimos optio aut, aperiam ipsa rerum reiciendis necessitatibus non
                    ipsam ex nobis iusto magnam est? Possimus id sit, laudantium obcaecati impedit corrupti temporibus
                    sapiente earum explicabo.
                    Quia esse nesciunt facere itaque, fuga eaque molestiae reprehenderit alias culpa soluta accusantium
                    repellat possimus voluptates reiciendis deleniti vero. Ea aut ad, voluptas modi voluptate a
                    provident unde rerum eum!
                    Pariatur repellendus sapiente quo similique vitae ea maxime laudantium ipsa veniam numquam voluptas
                    eos tempore voluptates, ratione magnam eius dolorem iste dolores velit. Magni minima, perferendis
                    quia numquam nesciunt modi.
                    Quisquam distinctio, ratione labore porro tempore sapiente modi vel fuga, sequi ducimus dolorum?
                    Quae perspiciatis eaque sed non saepe quam, assumenda, doloremque voluptas soluta quia labore
                    praesentium architecto dolore natus.
                    Illum temporibus voluptatem maiores quasi eius quas blanditiis magnam ratione, eaque quae, natus
                    deserunt quia quaerat. Explicabo impedit obcaecati, atque reiciendis, minus repellat officiis
                    facilis eaque eveniet ipsum veniam maxime!
                    Illo magni inventore dolorem molestiae aut et quis error asperiores repudiandae laudantium delectus
                    necessitatibus ullam pariatur aperiam voluptate aliquid, aliquam nulla incidunt ut doloribus? Error
                    quia aliquid iure dignissimos ea!
                    Provident, magnam? Repellendus, quibusdam? Facere, nemo vero odio officiis quis magnam natus dolorum
                    ipsa consequat<input type="text" placeholder="Type something"> ur provident eos necessitatibus quia
                    saepe magni aut dolore expedita rerum?
                    Exercitationem explicabo rem fuga aliquid.
                    Molestias iste neque eos excepturi mollitia expedita enim temporibus assumenda sit praesentium.
                    Alias dolorum tempora magni? Facere saepe quas consequuntur dolores incidunt nam suscipit quibusdam
                    sapiente, minus provident possimus modi.
                    Maiores necessitatibus facilis impedit qui, tempora, praesentium alias a placeat delectus
                    perspiciatis incidunt! Ipsum mollitia recusandae odio illum sit impedit facilis, harum saepe, iure
                    laboriosam velit numquam quis. Nam, ullam?
                    Magni, maxime. Necessitatibus, quaerat enim adipisci eligendi distinctio veniam expedita qui vel
                    corrupti repellendus in, consequuntur iusto cum iure vitae provident inventore et id, corporis eos
                    modi deserunt consectetur similique.
                    Provident, nisi? Harum neque eum unde, quos iste dolor nemo possimus vitae! Consequatur atque,
                    molestias reiciendis odio perferendis itaque consequuntur dolorem cumque porro minima beatae quam
                    aut voluptates commodi veniam?
                    Nobis earum voluptas porro facilis, esse laboriosam eligendi, eaque autem iure quo quibusdam, fugiat
                    tempore quidem praesentium dolorum dolore sapiente. Adipisci provident illum mollitia reprehenderit
                    illo natus, et fugiat dolorem.
                    Recusandae repellendus voluptates enim debitis quod illo ducimus sed! Ab<button>testing</button>
                    repellat magni, fuga optio
                    eos reiciendis incidunt voluptate aut ex esse fugiat ducimus quidem fugit cupiditate assumenda
                    asperiores, in beatae.
                    Et ex, laudantium temporibus odio facere accusamus molestias quibusdam iste enim iure neque quo
                    aperiam porro vitae nemo, quam autem repudiandae nisi. Blanditiis impedit, incidunt laudantium nulla
                    praesentium at eius?
                    Vitae debitis recusandae doloremque ad modi odio ipsam natus ullam nulla alias sapiente cupiditate
                    dolores porro ratione illum magnam cum, illo explicabo fugiat repellat, facilis sequi voluptate
                    beatae! Eaque<select>
                        <option>Option 1</option>
                        <option>Option 2</option>
                    </select>, similique?
                    Cupiditate vitae maiores iusto et recusandae tenetur! Minus
                    quisquam aperiam eum!
                    Totam nihil pariatur adipisci ea aspernatur nam? Dolores
                    ratione!<button>Testing</button>
                    Omnis incidunt, veniam nisi officiis ea, totam corporis possimus, harum soluta deleniti quo.
                    Repellat incidunt d<button>Testing</button>olore rerum quasi et animi nesciunt est facere,
                    reprehenderit ducimus numquam.
                    Quia mollitia doloribus officia.
                    Om<button>Testing</button>nis iusto maiores deserunt itaque, sed aliquid accusantium tempora quis
                    laboriosam ut. Incidunt
                    doloribus unde exer<button>Testing</button>citationem commodi possimus amet vitae, quas rem
                    consectetur blanditiis expedita
                    ex vel illo minima architecto.
                    Delectus, quo! Debitis corrupti esse deleniti quae voluptas sint recusandae quis a ve<a href="#">A
                        link</a>

                    neque temporibus sequi mollitia cum, ipsam illum fuga libero, laborum quidem harum dolorum iste!
                    Unde, porro?
                </p>
            </div>
        </div>

        <script>
            const customCSS = `
    ::-webkit-scrollbar {
        width: 10px;
    }
    ::-webkit-scrollbar-track {
        background: #27272a;
    }
    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 0.375rem;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
`;

            // Inject custom CSS into the page
            const styleTag = document.createElement("style");
            styleTag.textContent = customCSS;
            document.head.appendChild(styleTag);

            let labels = [];

            // Remove existing markings on the page
            function unmarkPage() {
                for (const label of labels) {
                    if (label.parentNode) {
                        document.body.removeChild(label);
                    }
                }
                labels = [];
            }

            // Mark the page elements with bounding boxes and labels
            function markPage() {
                unmarkPage();

                const elementsToMark = [
                    "input",
                    "textarea",
                    "select",
                    "button",
                    "a",
                    "iframe",
                    "video",
                ];

                let items = Array.from(document.querySelectorAll(elementsToMark.join(", ")))
                    .map((element) => {
                        const textualContent = element.textContent.trim().replace(/\s{2,}/g, " ");
                        const elementType = element.tagName.toLowerCase();
                        const ariaLabel = element.getAttribute("aria-label") || "";

                        const rects = [...element.getClientRects()].map((bb) => {
                            const rect = {
                                left: bb.left + window.scrollX,
                                top: bb.top + window.scrollY,
                                right: bb.right + window.scrollX,
                                bottom: bb.bottom + window.scrollY,
                            };
                            return {
                                ...rect,
                                width: rect.right - rect.left,
                                height: rect.bottom - rect.top,
                            };
                        });

                        const area = rects.reduce((acc, r) => acc + r.width * r.height, 0);

                        return {
                            element,
                            area,
                            rects,
                            text: textualContent,
                            type: elementType,
                            ariaLabel,
                        };
                    })
                    .filter((item) => item.area >= 20);

                function getRandomColor() {
                    const letters = "0123456789ABCDEF";
                    let color = "#";
                    for (let i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }

                items.forEach((item, index) => {
                    item.rects.forEach((bbox) => {
                        const newElement = document.createElement("div");
                        const borderColor = getRandomColor();
                        newElement.style.position = "absolute";
                        newElement.style.left = `${bbox.left}px`;
                        newElement.style.top = `${bbox.top}px`;
                        newElement.style.width = `${bbox.width}px`;
                        newElement.style.height = `${bbox.height}px`;
                        newElement.style.outline = `2px dashed ${borderColor}`;
                        newElement.style.pointerEvents = "none";
                        newElement.style.boxSizing = "border-box";
                        newElement.style.zIndex = 2147483647;

                        const label = document.createElement("span");
                        label.textContent = String(index); // Ensure it's a string
                        label.style.position = "absolute";
                        label.style.top = "-19px";
                        label.style.left = "0px";
                        label.style.background = borderColor;
                        label.style.color = "white";
                        label.style.padding = "2px 4px";
                        label.style.fontSize = "12px";
                        label.style.borderRadius = "2px";
                        newElement.appendChild(label);

                        document.body.appendChild(newElement);
                        labels.push(newElement);
                    });
                });

                return items; // Return items to make them accessible outside
            }

            // Load html2canvas if needed
            function loadDomToImageIfNeeded() {
                return new Promise((resolve, reject) => {
                    if (typeof window.domtoimage !== "undefined") {
                        console.log("dom-to-image-more is already loaded.");
                        resolve();
                        return;
                    }
                    const script = document.createElement("script");
                    script.src =
                        "https://cdn.jsdelivr.net/npm/dom-to-image-more@2.8.0/dist/dom-to-image-more.min.js";
                    script.onload = () => {
                        console.log("dom-to-image-more loaded successfully.");
                        if (typeof window.domtoimage !== "undefined") {
                            resolve();
                        } else {
                            reject(new Error("dom-to-image-more failed to load."));
                        }
                    };
                    script.onerror = () => reject(new Error("Error loading dom-to-image-more script."));
                    document.head.appendChild(script);
                });
            }

            // Capture page data as a screenshot and coordinates
            function getPageData() {
                return new Promise(async function () {
                    try {
                        console.time("getPageData Execution Time");
                        await loadDomToImageIfNeeded();

                        document.documentElement.style.overflow = "visible";
                        document.body.style.overflow = "visible";

                        // Mark the page and get the items array
                        const items = markPage();

                        await new Promise((resolve) => setTimeout(resolve, 10));

                        const pageHeight = document.documentElement.scrollHeight;
                        window.scrollTo(0, 0);

                        domtoimage
                            .toPng(document.documentElement, {
                                width: document.documentElement.scrollWidth,
                                height: pageHeight,
                            })
                            .then((dataURL) => {
                                unmarkPage();

                                const link = document.createElement("a");
                                link.href = dataURL;
                                link.download = "screenshot.png";
                                document.body.appendChild(link);

                                // Trigger the download
                                link.click();
                                link.remove();

                                // Collect coordinates from items
                                const coordinates = items.flatMap((item) =>
                                    item.rects.map(({ left, top, width, height }) => ({
                                        x: left + width / 2,
                                        y: top + height / 2,
                                        type: item.type,
                                        text: item.text,
                                        ariaLabel: item.ariaLabel,
                                    }))
                                );
                                console.log(coordinates);
                                return {
                                    coordinates: JSON.stringify(coordinates),
                                    img: dataURL,
                                };
                            })
                            .catch((error) => {
                                console.error("Error generating image:", error);
                            });
                    } catch (error) {
                        console.error("An error occurred:", error);
                    }
                });
            }

            // Confirm the main function exists
            console.log(typeof getPageData === "function");

            const button = document.querySelector("#screenshotButton");
            button.addEventListener("click", () => {
                getPageData().then(({ coordinates, img }) => {
                    console.log("Coordinates: ", coordinates);
                    console.log("Image Data URL: ", img);
                });
            });
        </script>



    </body>

</html>